---
layout: post
title: "Клонирование ОС с диска большего размера на диск меньшего размера"
date: 2025-03-04
categories: [Железо, Clonezilla]
tags: [Clonezilla, SSD, HDD, клонирование, ОС, UEFI]
description: "Перенос системы при помощи Clonezilla, в условиях, когда целевой диск (на который выполняется перенос ОС) меньшего объема, чем исходный."
---

# 0. Область применения

Данный метод предназначен для переноса рабочей ОС с одного физического диска на другой, в условиях, когда целевой диск (на который выполняется перенос ОС) меньшего объема, чем исходный. 
Например, вы решили ускорить свой старенький ноутбук при помощи SSD, но покупать SSD того же объема что и текущий HDD - дорого.

# 1. Подготовка

## Загружаем необходимое ПО:

* Программа для создания мультизагрузочной флешки: [Ventoy](https://ventoy.net/en/download.html). Можно использовать и любимый многими [Rufus](https://github.com/pbatard/rufus/releases), но в таком случае лучше подготовить несколько флешек;
* Непосредственно сама [Clonezilla](https://clonezilla.org/downloads.php);
* Легковесная live OS (можно выбрать любую: Debian, Ubuntu, Mint и другие, так как нам нужен от нее только GParted), я использую [SystemRescue](https://www.system-rescue.org/Download/).
* Образ Windows

Все необходимое закидываем на мультизагрузочную флешку, как пользоваться Ventoy

## Проверяем "железную" часть

На стационарном ПК - подключаем те диски, с которыми собираемся работать.

В случае, если операцию необходимо выполнить на ноутбуке без возможности установить целевой диск при помощи SATA-интерфейса (Optibay и т.п.), можно воспользоваться переходником SATA-USB.

# 2. Разметка

## Разметка дисков

Предположим, что объем исходного диска равен 512 Гб, а целевого - 256 Гб. В таком случае, если системный раздел превышает общую емкость целевого накопителя нам необходимо сжать системный раздел до размера менее общего размера накопителя минус 100-300 Мб на раздел загрузчика, в данном примере возьмем 228 Гб. 

### Общий порядок для работы с разметкой накопителей

1. Подключаем флешку, запускаем компьютер и запускаемся с флешки (чаще всего F2 или DEL, затем в Boot menu выставить нужный носитель) в интерфейсе Ventoy SystemRescue.
2. Как только SystemRescue будет загружен вы увидите приглашение bash "> $" введите startx и нажмите enter, после чего загрузиться графический интерфейс. 
3. Нажимаем комбинацию Ctrl+Alt+T, в открывшемся терминале пишем gparted. Альтернативно находим значок GParted и нажимаем его.
4. ***Важно!!!*** Контролируйте с каким диском вы работаете (правый верхний угол). Выбираем исходный диск, находим раздел с установленной ОС (для Windows это чаще всего ФС - NTFS, но будьте внимательны, если в системе присутствовал еще один локальный диск D:\, E:\ и т.д., он так же часто имеет ФС - NTFS, не перепутайте!) и сжимаем его до требуемого размера при помощи кнопки "Изменить размер/Переместить" ("Resize/Move"). ***Внимание!*** Все изменения применяются только после подтверждения. 
5. ***Важно!!!*** Контролируйте с каким диском вы работаете (правый верхний угол). Выбираем теперь целевой диск, если диск новый, то вероятней всего он не размечен, выбираем создать раздел и создаем загрузочный раздел 100-300 Мб с файловой системой FAT32. На том же целевом диске создаем раздел для будущей системы (можем задействовать все оставшееся пространство на диске). ***Внимание!*** Все изменения применяются только после подтверждения.
6. На этом с разметкой закончили. Перезагружаемся в Ventoy.

# 3. Клонирование раздела в Clonezilla

После запуска Clonezilla нас просят выбрать язык и раскладку, язык можно выбрать любой удобный для вас, раскладку лучше оставить по-умолчанию US.

## Выбор режима работы

Если у вас была возможность подключить оба диска в систему, то выбираем с диска на диск:

### DISK2DISK

* Выбираем "Начальный уровень".
* Выбираем клонировать локальный раздел на локальный раздел.
* Нам предлагает выбрать исходный локальный раздел, выбираем его (что бы не запутаться, в скобочках написан производитель диска, например Western Digital - WDC). ***Внимание!!!*** Нам нужен раздел с Windows, а НЕ с загрузчиком!
* С целевым разделом поступаем аналогично
* Далее нам предлагает выполнить проверку файловой системы, я обычно пропускаю её, так как если и обнаружаться бед блоки, это уже другая задача, которой стоит заняться отдельно.
* Далее нас спрашивают что делать по окончании клонирования, можно выбирать на свое усмотрение.
* В процессе клонирования нас еще несколько раз спросят точно ли мы уверены что хотим выполнить операцию, отвечаем утвердительно: y и нажимаем Enter

Если же возможности подключить оба диска не было - выберем работу с дисками используя образы:

### DISK2IMG

* placeholder
* placeholder
* placeholder
* placeholder
* placeholder
* placeholder

# 4. Загрузчик

Мы успешно скопировали все файлы ОС на новый накопитель, но загрузчик, который запускает нашу систему по прежнему находится на исходном диске и при запуске загружает систему с того же исходного диска. Что бы это исправить необходимо восстановить/создать загрузчик в разделе, который мы заботливо подготовили в разделе 2 на целевом диске.

***Рекомендую отключить исходный диск из системы, на время данной операции, дабы не создавать путанницу***

### Общий порядок восстановления загрузчика

* Загружаемся с образом Windows
* На стартовом экране нажимаем Shift+F10 (на ноутбуках и клавиатурах с медиаклавишами может быть Fn+Shift+F10) и видим командную строку.
* В командной строке пишем поочередно:
```bash
DISKPART
list vol
```
и мы видим список томов в системе:
![diskpart vol](assets/img/clonezilla_post_1/diskpart_1.png)

* Находим номер нужного нам тома (ФС должна быть FAT32 и небольшой размер 100-300 Мб) обращаем внимание на то, присвоена ли ему буква:

  + #### Если буква присутствует (например, C):

    - выходим из diskpart: 
    ```bash
    exit
    ```
    - восстанавливаем загрузчик:
    ```bash
    bcdboot  D:\Windows /s C: /f ALL
    ```
где, D: - буква тома где расположена целевая система Windows, C: - буква тома загрузчика, ALL - указание что загрузчик должен работать и в режиме Legacy, и в UEFI.

  + #### Если же буквы нет - нужно назначить её:
    - не выходя из diskpart выбираем нужный том и назначаем ему букву:
    ```bash
    sel vol 0
    assign letter=Z:
    exit
    ```
    - восстанавливаем загрузчик на том, с назначенной буквой:
    ```bash
    bcdboot  D:\Windows /s C: /f ALL
    ```
где, D: - буква тома где расположена целевая система Windows, C: - буква тома загрузчика, ALL - указание что загрузчик должен работать и в режиме Legacy, и в UEFI.

*Примечание. Если после успешного завершения операции в Windows отображается загрузочный раздел с той буквой, которую вы ему назначили, можно повторно воспользоваться diskpart что бы ее удалить (букву). Для этого выполните выберите том, но вместо `assign letter=Z:` напишите `remove letter=Z:`

# 5. Очистка исходного диска
После того, как Windows успешно запустилась и вы проверили её работоспособность - можно очистить исходный диск, для этого подключаем его (если отключали) и уже известными SystemRescue образом и утилитой GParted можем удалить/отформатировать разделы исходного диска. 